---
layout: default
title: Live View
---

<div x-data="live4thDown" x-init="startPolling()">
  <h1>Live Birds 4th Down Decision</h1>

  <template x-if="!isBirdsPlaying && !fourthDownPlays && !nextGame">
    <p>No Birds game found.</p>
  </template>

  <template x-if="nextGame">
    <div>
      <p><strong>Next Birds Game:</strong> <span x-text="nextGame.name"></span></p>
      <p><strong>Start Time:</strong> <span x-text="nextGame.date"></span></p>
    </div>
  </template>

  <template x-if="fourthDownPlays && !isBirdsPlaying">
    <div>
      <p><strong>Last Birds Game:</strong> <span x-text="fourthDownPlays.game"></span></p>
      <p><strong>Final Score:</strong> <span x-text="fourthDownPlays.score"></span></p>
    </div>
  </template>

  <template x-if="fourthDownPlays">
    <ul class="tile-list full">
      <template x-for="play in fourthDownPlays" :key="play.id">
      <li>
          <div>
            <div x-text="`${play.downDistance} | Q${play.period?.number} ${play.clock} | Birds are ${play.birds_winning_status} ${play.high_score}-${play.low_score}`"></div>
            <div x-text="`Recommendation: ${play.typeText} | ${play.birds_coach}: ${play.typeAbbr === 'Rush' || play.typeAbbr === 'Pass' ? 'Go for it' : play.typeText }`"></div>

            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>Win%</th>
                  <th>Success%</th>
                  <th>Fail</th>
                  <th>Succeed</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Go for it</td>
                  <td x-text="play.go_wp !== 'NA' ? Math.round(play.go_wp * 100) : ''"></td>
                  <td x-text="play.first_down_prob !== 'NA' ? Math.round(play.first_down_prob * 100) : ''"></td>
                  <td x-text="play.wp_fail !== 'NA' ? Math.round(play.wp_fail * 100) : ''"></td>
                  <td x-text="play.wp_succeed !== 'NA' ? Math.round(play.wp_succeed * 100) : ''"></td>
                </tr>
                <tr>
                  <td>Punt</td>
                  <td x-text="play.punt_wp !== 'NA' ? Math.round(play.punt_wp * 100) : ''"></td>
                  <td>NA</td>
                  <td>NA</td>
                  <td>NA</td>
                </tr>
                <tr>
                  <td>Field goal</td>
                  <td x-text="play.fg_wp !== 'NA' ? Math.round(play.fg_wp * 100) : ''"></td>
                  <td x-text="play.fg_prob !== 'NA' ? Math.round(play.fg_prob * 100) : ''"></td>
                  <td x-text="play.miss_fg_wp !== 'NA' ? Math.round(play.miss_fg_wp * 100) : ''"></td>
                  <td x-text="play.make_fg_wp !== 'NA' ? Math.round(play.make_fg_wp * 100) : ''"></td>
                </tr>
              </tbody>
            </table>
            <div x-text="play.text || ''"></div>
          </div>
        </li>
      </template>
    </ul>
  </template>
</div>

<script>
function simplifyPlay(play) {
  return {
    id: play.id,
    typeText: play.type?.text || '',
    typeAbbr: play.type?.abbreviation || '',
    description: play.text || '',
    quarter: play.period?.number ?? null,
    clock: play.clock?.displayValue || '',
    offenseTeamId: play.team?.$ref?.split('/').pop() || null,
    downDistance: play.start?.downDistanceText || '',

    // Added fields
    quarter_seconds_remaining: play.clock?.value ?? null,
    home_team: play.competitors?.find(t => t.home)?.team?.abbreviation || '',
    away_team: play.competitors?.find(t => t.away)?.team?.abbreviation || '',
    home_score: play.homeScore ?? null,
    away_score: play.awayScore ?? null,
    home_coach: 'UnknownH', // not available in ESPN play-by-play
    away_coach: 'UnknownA', // not available in ESPN play-by-play
    home_timeouts_remaining: play.homeTimeouts ?? null,
    away_timeouts_remaining: play.awayTimeouts ?? null,
    down: play.start?.down ?? null,
    ydstogo: play.start?.distance ?? null,
    yrdln: play.start?.yardLine || '',
    qtr: play.period?.number ?? null,
    model_recommendation: play.summary || '',
    actual_decision: play.type?.text || '',
    go_wp: play.go_wp ?? null,
    first_down_prob: play.first_down_prob ?? null,
    wp_fail: play.wp_fail ?? null,
    wp_succeed: play.wp_succeed ?? null,
    punt_wp: play.punt_wp ?? null,
    fg_wp: play.fg_wp ?? null,
    fg_prob: play.fg_prob ?? null,
    miss_fg_wp: play.miss_fg_wp ?? null,
    make_fg_wp: play.make_fg_wp ?? null,
  };
}

function addBirdsContext(play) {
  play.birdsIsHome = play.homeTeam?.$ref?.endsWith('/21');
  play.birds_score = play.birdsIsHome ? play.homeScore : play.awayScore;
  play.opp_score = play.birdsIsHome ? play.awayScore : play.homeScore;
  play.birds_team = play.birdsIsHome ? play.homeTeamAbbreviation : play.awayTeamAbbreviation;
  play.opp_team = play.birdsIsHome ? play.awayTeamAbbreviation : play.homeTeamAbbreviation;
  play.birds_coach = play.birdsIsHome ? play.home_coach : play.away_coach;
  play.birds_winning_status = play.birds_score > play.opp_score ? 'winning' :
                               play.birds_score < play.opp_score ? 'losing' : 'tied';
  play.high_score = Math.max(play.homeScore, play.awayScore);
  play.low_score = Math.min(play.homeScore, play.awayScore);
  return play;
}

function fetchFourthDownPlaysForGame(gameId) {
  return fetch(`https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/events/${gameId}/competitions/${gameId}/plays?limit=1000`)
    .then(res => res.json())
    .then(playsData => {
      const rawPlays = playsData.items || [];
      console.log("Total plays fetched:", rawPlays.length);
      const filteredPlays = rawPlays
        .filter(p =>
          p.start?.down === 4 &&
          p.start?.team?.$ref?.includes('/21')
        )
        .map(p => {
          const simplified = { ...p, ...simplifyPlay(p) };
          return addBirdsContext(simplified);
        });
      console.log("All 4th down plays count:", filteredPlays.length);
      return filteredPlays;
    });
}

  const params = new URLSearchParams(window.location.search);
  const gameId = params.get('espn_game_id');

  document.addEventListener('alpine:init', () => {
    Alpine.data('live4thDown', () => ({
      fourthDownPlays: null,
      latestHeader: null,
      isBirdsPlaying: false,
      nextGame: null,
      //intervalMs: 30000,
      intervalMs: null,
      startPolling() {
        this.poll();
        //setInterval(() => this.poll(), this.intervalMs);
      },
      poll() {
        if (gameId) {
          this.isBirdsPlaying = true;
          this.nextGame = null;
          fetchFourthDownPlaysForGame(gameId)
            .then(filteredPlays => {
              this.fourthDownPlays = filteredPlays;
              if (filteredPlays.length > 0) {
                const latest = filteredPlays[0];
                this.latestHeader = {
                  game: `Game ID: ${gameId}`,
                  quarter: latest.period?.number || "N/A",
                  clock: latest.clock?.displayValue || "N/A",
                  downDistance: latest.start?.downDistanceText || `${latest.start.down} & ${latest.start.distance}`,
                  recommendation: latest.summary || "",
                  score: "Score unknown"
                };
              }
            });
          return;
        }
        console.log('Polling...');
        fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard')
          .then(res => res.json())
          .then(data => {
            const games = data.events || [];
            console.log("Games:", games);
            const birdsGame = games.find(game =>
              game.competitions?.[0]?.competitors?.some(team => team.team.id === "21")
            );
            console.log("Birds Game:", birdsGame);

            if (!birdsGame) {
              this.fourthDownPlays = null;
              this.latestHeader = null;
              this.isBirdsPlaying = false;
              this.nextGame = null;
            } else {
              const gameState = birdsGame.status?.type?.state;
              const isActive = gameState === "in";

              this.isBirdsPlaying = isActive;

              const opponent = birdsGame.competitions[0].competitors.find(team => team.team.id !== "21")?.team?.displayName || "Opponent";

              if (isActive) {
                this.latestHeader = {
                  game: `vs ${opponent}`,
                  quarter: birdsGame.status?.period,
                  clock: birdsGame.status?.displayClock,
                  downDistance: "N/A",
                  recommendation: birdsGame.status?.type?.description || "N/A",
                  score: birdsGame.competitions[0].competitors.map(t => `${t.team.abbreviation}: ${t.score}`).join(" vs ")
                };
                const eventId = birdsGame.id;
                fetchFourthDownPlaysForGame(eventId)
                  .then(filteredPlays => {
                    this.fourthDownPlays = filteredPlays;
                    console.log("Fourth down plays:", this.fourthDownPlays);
                    if (filteredPlays.length > 0) {
                      const latest = filteredPlays[0];
                      this.latestHeader = {
                        game: `vs ${opponent}`,
                        quarter: latest.period?.number || "N/A",
                        clock: latest.clock?.displayValue || "N/A",
                        downDistance: latest.start?.downDistanceText || `${latest.start.down} & ${latest.start.distance}`,
                        recommendation: latest.summary || "",
                        score: this.latestHeader.score
                      };
                    } else {
                      this.fourthDownPlays = [];
                    }
                  });
                this.nextGame = null;
              } else {
                const isFuture = birdsGame.status?.type?.state === "pre";
                const isPast = birdsGame.status?.type?.completed;

                if (isFuture) {
                  this.fourthDownPlays = null;
                  this.latestHeader = null;
                  this.nextGame = {
                    name: `vs ${opponent}`,
                    date: new Date(birdsGame.date).toLocaleString('en-US', {
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true,
                      month: 'long',
                      day: 'numeric',
                      year: 'numeric'
                    })
                  };
                } else if (isPast) {
                  this.fourthDownPlays = null;
                  this.latestHeader = {
                    game: `vs ${opponent}`,
                    quarter: "Final",
                    clock: "",
                    downDistance: "",
                    recommendation: "Game Complete",
                    score: birdsGame.competitions[0].competitors.map(t => `${t.team.abbreviation}: ${t.score}`).join(" vs ")
                  };
                  this.nextGame = null;
                } else {
                  this.fourthDownPlays = null;
                  this.latestHeader = null;
                  this.nextGame = null;
                }
              }
            }
          });
      }
    }));
  });
</script>