---
layout: default
title: Live View
---

<div x-data="live4thDown" x-init="startPolling()">
  <h1>Live Birds 4th Down Decision</h1>

  <template x-if="!isBirdsPlaying && !fourthDownPlays && !nextGame">
    <p>No Birds game found.</p>
  </template>

  <template x-if="nextGame">
    <div>
      <p><strong>Next Birds Game:</strong> <span x-text="nextGame.name"></span></p>
      <p><strong>Start Time:</strong> <span x-text="nextGame.date"></span></p>
    </div>
  </template>

  <template x-if="fourthDownPlays && !isBirdsPlaying">
    <div>
      <p><strong>Last Birds Game:</strong> <span x-text="fourthDownPlays.game"></span></p>
      <p><strong>Final Score:</strong> <span x-text="fourthDownPlays.score"></span></p>
    </div>
  </template>

  <template x-if="isBirdsPlaying && latestHeader">
    <div>
      <div>
        <p><strong x-text="latestHeader.game"></strong></p>
        <p><strong x-text="`Q${latestHeader.quarter} • ${latestHeader.clock} • ${latestHeader.downDistance}`"></strong></p>
      </div>
    </div>
  </template>

  <template x-if="fourthDownPlays">
    <ul class="tile-list full">
      <template x-for="play in fourthDownPlays" :key="play.id">
        <li>
          <div>
            <!-- Row 1 -->
            <div>
              <div x-text="`4th & ${play.start?.distance} at ${play.start?.yardLine || 'N/A'}`"></div>
              <div x-text="`Recommendation: ${play.recommendation || 'N/A'}`"></div>
            </div>

            <!-- Row 2 -->
            <div>
              <div x-text="`${Math.floor(play.clock?.value / 60)}:${String(play.clock?.value % 60).padStart(2, '0')} Q${play.period?.number}`"></div>
              <div x-text="`Actual Decision: ${play.text || 'N/A'}`"></div>
            </div>

            <!-- Row 3 -->
            <div>
              <div>Go:</div>
              <div x-text="play.go_wp !== 'NA' ? Math.round(play.go_wp * 100) : ''"></div>
              <div>FG:</div>
              <div x-text="play.fg_wp !== 'NA' ? Math.round(play.fg_wp * 100) : ''"></div>
              <div>Punt:</div>
              <div x-text="play.punt_wp !== 'NA' ? Math.round(play.punt_wp * 100) : ''"></div>
            </div>

            <!-- Row 4 -->
            <div>
              <div>Success:</div>
              <div x-text="play.wp_succeed !== 'NA' ? Math.round(play.wp_succeed * 100) : ''"></div>
              <div>Fail:</div>
              <div x-text="play.wp_fail !== 'NA' ? Math.round(play.wp_fail * 100) : ''"></div>
            </div>

            <!-- Row 5 -->
            <div>
              <span>Description:</span>
              <code x-text="play.text || ''"></code>
            </div>
          </div>
        </li>
      </template>
    </ul>
  </template>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const gameId = params.get('espn_game_id');

  document.addEventListener('alpine:init', () => {
    Alpine.data('live4thDown', () => ({
      fourthDownPlays: null,
      latestHeader: null,
      isBirdsPlaying: false,
      nextGame: null,
      //intervalMs: 30000,
      intervalMs: null,
      startPolling() {
        this.poll();
        //setInterval(() => this.poll(), this.intervalMs);
      },
      poll() {
        if (gameId) {
          this.isBirdsPlaying = true;
          this.nextGame = null;
          fetch(`https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/events/${gameId}/competitions/${gameId}/plays`)
            .then(res => res.json())
            .then(playsData => {
              const items = playsData.items || [];
              const fourthDowns = (items || [])
                .filter(play => play.start?.down === 4)
                .sort((a, b) => b.id - a.id); // newest first
              if (fourthDowns.length > 0) {
                const latest = fourthDowns[0];
                this.latestHeader = {
                  game: `Game ID: ${gameId}`,
                  quarter: latest.period?.number || "N/A",
                  clock: latest.clock?.displayValue || "N/A",
                  downDistance: latest.start?.downDistanceText || `${latest.start.down} & ${latest.start.distance}`,
                  recommendation: latest.summary || "",
                  score: "Score unknown"
                };
              }
              this.fourthDownPlays = fourthDowns;
            });
          return;
        }
        console.log('Polling...');
        fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard')
          .then(res => res.json())
          .then(data => {
            const games = data.events || [];
            console.log("Games:", games);
            const birdsGame = games.find(game =>
              game.competitions?.[0]?.competitors?.some(team => team.team.id === "21")
            );
            console.log("Birds Game:", birdsGame);

            if (!birdsGame) {
              this.fourthDownPlays = null;
              this.latestHeader = null;
              this.isBirdsPlaying = false;
              this.nextGame = null;
            } else {
              const gameState = birdsGame.status?.type?.state;
              const isActive = gameState === "in";

              this.isBirdsPlaying = isActive;

              const opponent = birdsGame.competitions[0].competitors.find(team => team.team.id !== "21")?.team?.displayName || "Opponent";

              if (isActive) {
                this.latestHeader = {
                  game: `vs ${opponent}`,
                  quarter: birdsGame.status?.period,
                  clock: birdsGame.status?.displayClock,
                  downDistance: "N/A",
                  recommendation: birdsGame.status?.type?.description || "N/A",
                  score: birdsGame.competitions[0].competitors.map(t => `${t.team.abbreviation}: ${t.score}`).join(" vs ")
                };
                const eventId = birdsGame.id;
                fetch(`https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/events/${eventId}/competitions/${eventId}/plays`)
                  .then(res => res.json())
                  .then(playsData => {
                    const items = playsData.items || [];
                    const fourthDowns = (items || [])
                      .filter(play => play.start?.down === 4)
                      .sort((a, b) => b.id - a.id); // newest first
                    console.log("Fourth down plays:", fourthDowns);
                    if (fourthDowns.length > 0) {
                      this.fourthDownPlays = fourthDowns;
                      const latest = fourthDowns[0];
                      this.latestHeader = {
                        game: `vs ${opponent}`,
                        quarter: latest.period?.number || "N/A",
                        clock: latest.clock?.displayValue || "N/A",
                        downDistance: latest.start?.downDistanceText || `${latest.start.down} & ${latest.start.distance}`,
                        recommendation: latest.summary || "",
                        score: this.latestHeader.score
                      };
                    } else {
                      this.fourthDownPlays = [];
                    }
                  });
                this.nextGame = null;
              } else {
                const isFuture = birdsGame.status?.type?.state === "pre";
                const isPast = birdsGame.status?.type?.completed;

                if (isFuture) {
                  this.fourthDownPlays = null;
                  this.latestHeader = null;
                  this.nextGame = {
                    name: `vs ${opponent}`,
                    date: new Date(birdsGame.date).toLocaleString('en-US', {
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true,
                      month: 'long',
                      day: 'numeric',
                      year: 'numeric'
                    })
                  };
                } else if (isPast) {
                  this.fourthDownPlays = null;
                  this.latestHeader = {
                    game: `vs ${opponent}`,
                    quarter: "Final",
                    clock: "",
                    downDistance: "",
                    recommendation: "Game Complete",
                    score: birdsGame.competitions[0].competitors.map(t => `${t.team.abbreviation}: ${t.score}`).join(" vs ")
                  };
                  this.nextGame = null;
                } else {
                  this.fourthDownPlays = null;
                  this.latestHeader = null;
                  this.nextGame = null;
                }
              }
            }
          });
      }
    }));
  });
</script>